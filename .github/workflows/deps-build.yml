name: Build Dependencies

# Triggered by pushing a deps version tag, or manually.
on:
  push:
    tags: ["deps-v*.*.*"]
  workflow_dispatch:

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  # Pin native library versions — keep in sync with build.rs HEADER_URL.
  LIBKRUN_VERSION: "1.17.4"
  LIBKRUNFW_VERSION: "5.2.1"

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-apple-darwin
            os: macos-latest
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-24.04-arm

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install llvm
          LLVM_BIN="$(brew --prefix llvm)/bin"
          echo "$LLVM_BIN" >> "$GITHUB_PATH"
          # clang -fuse-ld=lld looks for 'ld.lld' — create symlink if brew didn't
          [ -f "$LLVM_BIN/ld.lld" ] || ln -sf "$LLVM_BIN/lld" "$LLVM_BIN/ld.lld"

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential patchelf libfdt-dev clang libclang-dev libcap-ng-dev

      - name: Build libkrunfw (macOS)
        if: runner.os == 'macOS'
        run: |
          git clone --depth 1 --branch "v${LIBKRUNFW_VERSION}" \
            https://github.com/containers/libkrunfw.git libkrunfw-src
          cd libkrunfw-src
          curl -fsSL "https://github.com/containers/libkrunfw/releases/download/v${LIBKRUNFW_VERSION}/libkrunfw-prebuilt-aarch64.tgz" | tar xz
          cd libkrunfw
          make -j$(sysctl -n hw.ncpu)
          make PREFIX="${{ github.workspace }}/prefix" install

      - name: Download libkrunfw (Linux)
        if: runner.os == 'Linux'
        run: |
          ARCH=$(uname -m)
          mkdir -p "${{ github.workspace }}/prefix"
          curl -fsSL "https://github.com/containers/libkrunfw/releases/download/v${LIBKRUNFW_VERSION}/libkrunfw-${ARCH}.tgz" | \
            tar xz -C "${{ github.workspace }}/prefix"

      - name: Build libkrun
        run: |
          git clone --depth 1 --branch "v${LIBKRUN_VERSION}" --recurse-submodules \
            https://github.com/containers/libkrun.git libkrun-src
          cd libkrun-src

          if [ "${{ runner.os }}" = "macOS" ]; then
            export PKG_CONFIG_PATH="${{ github.workspace }}/prefix/lib/pkgconfig"
            # Use brew's clang + explicit ld.lld path (system clang cannot find lld).
            LLVM_BIN="$(brew --prefix llvm)/bin"
            make -j$(sysctl -n hw.ncpu) NET=1 BLK=1 \
              "CC_LINUX=${LLVM_BIN}/clang -target arm64-linux-gnu -fuse-ld=${LLVM_BIN}/ld.lld -Wl,-strip-debug --sysroot \$(SYSROOT_LINUX) -Wno-c23-extensions"
          else
            export PKG_CONFIG_PATH="${{ github.workspace }}/prefix/lib64/pkgconfig"
            make -j$(nproc) NET=1 BLK=1
          fi

          make PREFIX="${{ github.workspace }}/prefix" install

      - name: Package libraries
        run: |
          mkdir dist

          # Copy library files (-L follows symlinks to the versioned real file)
          # and fix SONAME / install_name for clean redistribution.
          if [ "${{ runner.os }}" = "macOS" ]; then
            LIB="${{ github.workspace }}/prefix/lib"
            cp -L "$LIB/libkrun.dylib" dist/
            cp -L "$LIB/libkrunfw.dylib" dist/
            install_name_tool -id "@rpath/libkrun.dylib" dist/libkrun.dylib
            install_name_tool -id "@rpath/libkrunfw.dylib" dist/libkrunfw.dylib
            codesign -s - --force dist/libkrun.dylib
            codesign -s - --force dist/libkrunfw.dylib
          else
            LIB="${{ github.workspace }}/prefix/lib64"
            cp -L "$LIB/libkrun.so" dist/
            cp -L "$LIB/libkrunfw.so" dist/
            patchelf --set-soname libkrun.so dist/libkrun.so
            patchelf --set-soname libkrunfw.so dist/libkrunfw.so
          fi

          ls -la dist/
          tar -czf "bux-deps-${{ matrix.target }}.tar.gz" -C dist .

      - uses: actions/upload-artifact@v4
        with:
          name: bux-deps-${{ matrix.target }}
          path: bux-deps-${{ matrix.target }}.tar.gz

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/deps-v')
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          merge-multiple: true
      - uses: softprops/action-gh-release@v2
        with:
          files: bux-deps-*.tar.gz
          generate_release_notes: true

  publish-sys:
    needs: release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/deps-v')
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo publish -p bux-sys
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
